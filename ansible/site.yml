---
- name: Couchbase setup - git
  hosts: all
  tasks:
  - name: update all packages
    yum:
      state: latest
      name: '*'
      update_cache: true
  - name: install git
    yum:
      state: present
      name: git
#  - name: Clone git repository
#    git:
#      repo: 'https://github.com/whitespace-software/ServerConfiguration'
#      repo: 'https://github.com/couchbase-partners/azure-resource-manager-couchbase.git'
#      dest: '~/github/'
#    ignore_errors: true

# play below requires PyOpenSSL module >= 0.15 installed locally.
- name: generate selfsigned ssl certificate locally
  hosts: localhost
  become: false
  tasks:
  - name: generate openssl private key
    openssl_privatekey:
      path: files/wssskey.pem
      size: 2048
  - name: generate certificate request
    openssl_csr:
      path: files/wssscert.csr
      privatekey_path: files/wssskey.pem
      common_name: www.wssscert.com
  - name: generate a self signed openssl certificate
    openssl_certificate:
      path: files/wssscert.pem
      privatekey_path: files/wssskey.pem
      csr_path: files/wssscert.csr
      provider: selfsigned


- name: Couchbase setup - nginx
  hosts: all
  tasks:
  - name: install prerequisites
    yum:
      state: present
      name:
       - policycoreutils-python
       - yum-utils
  - name: install nginx stable repository
    yum_repository:
      name: nginx-stable
      description: nginx stable repo
      baseurl: 'http://nginx.org/packages/centos/$releasever/$basearch/'
      enabled: no
      gpgcheck: yes
      gpgkey: 'https://nginx.org/keys/nginx_signing.key'
      file: 'nginx.repo'
  - name: install nginx mainline repository
    yum_repository:
      name: nginx-mainline
      description: nginx mainline repo
      baseurl: 'http://nginx.org/packages/mainline/centos/$releasever/$basearch/'
      enabled: yes
      gpgcheck: yes
      gpgkey: 'https://nginx.org/keys/nginx_signing.key'
      file: 'nginx.repo'
  - name: install nginx
    yum:
      name: nginx
      state: present
  - name: install configuration files
    copy:
      src: 'default.conf'
      dest: '/etc/nginx/conf.d/default.conf'
      owner: nginx
      group: nginx
      mode: 0644
  - name: create nginx ssl directory
    file:
      dest: /etc/nginx/ssl
      state: directory
      owner: nginx
      group: nginx
      mode: 0750
  - name: copy self signed certificate to instance
    copy:
      src: "{{ item }}"
      dest: "/etc/nginx/ssl/{{ item }}"
      owner: nginx
      group: nginx
      mode: 0644
    with_items:
     - wssscert.pem
     - wssskey.pem
  - name: enable high port for nginx in selinux
    seport:
      ports: 18100
      proto: tcp
      setype: http_port_t
      state: present


- name: Couchbase setup - docker and docker-compose
  hosts: all
  vars:
    docker_compose_version: '1.24.0'
    docker_user: admin-user
  tasks:
  - name: install docker prerequisites
    yum:
      name:
      - ca-certificates
      - yum-utils
      - device-mapper-persistent-data
      - lvm2
      - python-docker-py
      state: present
  - name: install docker repository
    get_url:
      dest: '/etc/yum.repos.d/docker-ce.repo'
      mode: 0440
      url: 'https://download.docker.com/linux/centos/docker-ce.repo'
  - name: install docker
    yum:
      name: docker-ce
      state: present
  - name: add docker user to docker group
    user:
      name: "{{ docker_user }}"
      groups: docker
      append: yes
  - name: install docker-composer
    get_url:
      dest: '/usr/local/bin/docker-compose'
      url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-Linux-x86_64"
      checksum: 'sha256:https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-Linux-x86_64.sha256'
      mode: 0755

- name: Couchbase setup - azure-cli
  hosts: all
  vars:
    docker_user : admin-user
  tasks:
  - name: install azure-cli repository
    yum_repository:
      name: azure-cli
      description: Azure CLI
      baseurl: 'https://packages.microsoft.com/yumrepos/azure-cli'
      enabled: yes
      gpgcheck: yes
      gpgkey: 'https://packages.microsoft.com/keys/microsoft.asc'
      file: 'azure-cli.repo'
  - name: install azure-cli
    yum:
      name: azure-cli
      state: present
  - name: copy azure scripts
    copy:
      src: "{{ item }}"
      dest: "/home/{{ docker_user }}/{{ item }}"
      owner: "{{ docker_user }}"
      group: "{{ docker_user }}"
      mode: 0744
    with_items:
      - updateAllContainers.sh
      - updateReVAPI.sh
  - name : copy container template
    copy:
      src: 'sync_gateway.json'
      dest: '/home/sync_gateway/sync_gateway.json'
  - name: restart services
    systemd:
      state: restarted
      enabled: true
      name: "{{ item }}"
    with_items:
     - sync_gateway
     - nginx
     - docker
- name: Couchbase setup - docker images
  hosts: all
  become_user: admin-user
  vars:
    docker_registry_user: "79b9cf91-8e83-4ac3-a24e-4fc74f791510"
    docker_registry_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36303566303261313137363632303432363263623364353631303863616530303234343036386366
          6661323437343032323633326338363630653434323235350a376464346262653333656331343766
          32366430623933336632353334363061353966326630313937363464316336366235613338626161
          3433333334316563340a663838303965383564393939323230326565353639353166646532333333
          39646661326437333234626336646530333464653138613833373338336431643566623634393265
          3637313762613362326339356231326165656435643561616566
    docker_user : admin-user
  tasks:
  - name: Log into private registry and force re-authorization
    docker_login:
      registry: wsinternalcontainerregistry.azurecr.io
      username: "{{ docker_registry_user }}"
      password: "{{ docker_registry_password }}"
      reauthorize: yes
  - name: create docker folder
    file:
      path: "/home/{{ docker_user }}/{{ item }}"
      state: directory
    with_items:
      - "docker"
  - name: copy docker compose file
    copy:
      src: "{{ item }}"
      dest: "/home/{{ docker_user }}/docker/{{ item }}"
    with_items:
      - docker-compose.yml
  # - name: Run the updateAllContainers.sh script
  #   shell: "bash updateAllContainers.sh"
  #   args:
  #     chdir: "/home/{{ docker_user }}"